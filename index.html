<html>
    
    <head>
        <title id="title">Side-by-Side Player</title>
        <style>
            .playerCells > td {
                width: 425px;
                height: 358px;
            }
            td {
                padding-bottom: 0px;
            }
            .centerElement {
                margin-left: auto;
                margin-right: auto;
            }
            input[name="textArea"] {
                width: 99%;
            }
            input[name="number"] {
                max-width: 15%;
                min-width: 8%;
            }
            /*#groupVolume {
                float: left;
                clear: both;
				width: 70%;
            }*/
            input[type="button"][id^="mute"] {
                float: right;
                clear: both;
            }
			#lastModified {
				position: fixed;
				bottom: 0;
				right: 0;
				padding: 5px;
			}
        </style>
    </head>
    
    <body>
		<div id="lastModified">Last Modified:</div>
        <table cellspacing="4" cellpadding="0" border="0" class="centerElement" style="text-align: center">
            <colgroup>
                <col style="width: 10%">
                    <col span="2" style="width: 40%">
                        <col style="width: 10%">
            </colgroup>
            <tbody>
                <tr class="playerCells">
                    <td valign="top" colspan="2">
                        <div id="player0"></div>
                    </td>
                    <td valign="top" colspan="2">
                        <div id="player1"></div>
                    </td>
                </tr>
                <tr>
                    <th style="width: 10%">
                        <input type="button" width="100%" onclick="toggleVideos()" value="Play" id="playPause">
                    </th>
                    <th style="width: 40%">Video 1</th>
                    <th style="width: 40%">Video 2</th>
                    <th style="width: 10%">Apply</th>
                </tr>
                <tr>
                    <th>Set Video:</th>
                    <td>
                        <input type="text" name="textArea" id="video0">
                    </td>
                    <td>
                        <input type="text" name="textArea" id="video1">
                    </td>
                    <td>
                        <input type="button" onclick="setVideos()" value="Set">
                    </td>
                </tr>
                <tr>
                    <th>Set Time:</th>
                    <td>Hours:
                        <input type="text" min="0" name="number" id="timeHours0" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">Minutes:
                        <input type="text" min="0" name="number" id="timeMinutes0" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">Seconds:
                        <input type="text" min="0" name="number" id="timeSeconds0" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">
                    </td>
                    <td>Hours:
                        <input type="text" min="0" name="number" id="timeHours1" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">Minutes:
                        <input type="text" min="0" name="number" id="timeMinutes1" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">Seconds:
                        <input type="text" min="0" name="number" id="timeSeconds1" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">
                    </td>
                    <td>
                        <input type="button" onclick="setTimes()" value="Set">
                    </td>
                </tr>
                <tr>
                    <th></th>
                    <td>
                        <input type="number" min="0" max="100" name="number" id="volume0" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">
                        <input type="button" onclick="setVolume(0)" value="Set">
                        <input type="button" onclick="toggleMute(0)" value="Mute" id="mute0">
                    </td>
                    <td>
                        <input type="number" min="0" max="100" name="number" id="volume1" onkeydown="return (event.ctrlKey || event.altKey || (47 < event.keyCode && event.keyCode < 58 && event.shiftKey == false) || (95 < event.keyCode && event.keyCode < 106) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode > 34 && event.keyCode < 40) || (event.keyCode == 46))">
                        <input type="button" onclick="setVolume(1)" value="Set">
                        <input type="button" onclick="toggleMute(1)" value="Mute" id="mute1">
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <th>Convert YTD Link:</th>
                    <td colspan="2">
                        <input type="text" name="textArea" id="doubler">
                    </td>
                    <td>
                        <input type="button" onclick="processDoubler()" value="Submit">
                    </td>
                </tr>
                <tr>
                    <th>Permalink:</th>
                    <td colspan="3">
                        <input type="text" name="textArea" id="perma">
                    </td>
                </tr>
            </tbody>
        </table>
        <script>
            var tag = document.createElement('script');

            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            var stopState = 0;
            var debug = 1;
            var done = false;
			var playerSettings = function (videoID, time, volume, mute) {
				this.videoID = videoID || "qeMFqkcPYcg";
				this.time = time || 0;
				this.volume = volume || 100;
				this.mute = mute || 0;
			};
			var def = new playerSettings();
			var init = [];
			init.push( new playerSettings("qeMFqkcPYcg", 1) );
			init.push( new playerSettings("g1AJdg3zxlw") );
			var settings = [];
			settings.push( init[0] );
			settings.push( init[1] );
            var player = [];
			var elements = { playPause: document.getElementById("playPause"), doubler: document.getElementById("doubler"), perma: document.getElementById("perma"), title: document.getElementById("title"), player: [] };
			var playerElements = function (i) {
				this.videoID = document.getElementById("video" + i);
				this.volume = document.getElementById("volume" + i);
				this.mute = document.getElementById("mute" + i);
				this.time = { hours: document.getElementById("timeHours" + i), minutes: document.getElementById("timeMinutes" + i), seconds: document.getElementById("timeSeconds" + i) };
			};
            var playerEvents = {
                'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
            };
			var titles = {};
			document.getElementById("lastModified").innerHTML += " " + document.lastModified;
			window.addEventListener("hashchange", updateVideo, false);

            function onYouTubeIframeAPIReady() {
                if (debug) console.log("Side-by-Side Player: Website - " + window.location.href);
				var tempParam = paramArray(window.location.href);
                for (var i = 0; i < settings.length; i++) {
					elements.player[i] = new playerElements(i);
					if (debug) console.log("Side-by-Side Player: Parameters (Object) - " + tempParam);
                    if (tempParam) {
                        if (('video' + i) in tempParam) settings[i].videoID = tempParam['video' + i];
                        if (('start' + i) in tempParam) settings[i].time = tempParam['start' + i];
                        if (('volume' + i) in tempParam) settings[i].volume = tempParam['volume' + i];
                        if (('mute' + i) in tempParam) settings[i].mute = tempParam['mute' + i];
                    }
                    player.push(new YT.Player('player' + i, {
                        height: '100%',
                        width: '100%',
                        videoId: settings[i].videoID,
                        playerVars: {
                            'start': settings[i].time,
                                'controls': 0,
                                'showinfo': 0,
                                'rel': 0,
                                'theme': "light"
                        },
                        events: playerEvents
                    }));
                    player[i].num = i;
                    elements.player[i].videoID.value = settings[i].videoID;
                    elements.player[i].volume.value = settings[i].volume;
                    //time[i].value = settings[i].time;
                    sToHMS(settings[i].time, i);
                }
                writePerma(1);
            }

            function onPlayerReady(event) {
                event.target.setVolume(settings[event.target.num].volume);
				if(settings[event.target.num].mute) toggleMute(event.target.num, 1);
                //event.target.playVideo();
				titles[event.target.num] = event.target.getVideoData().title;
				writeTitle();
            }

            function onPlayerStateChange(event) {
                switch (event.data) {
                    case YT.PlayerState.ENDED:
                        //stopVideos(event, 1);
                        stopState = 1;
                        stopVideos(event, 1);
                        elements.playPause.value = "Play";
                        break;
                    case YT.PlayerState.PLAYING:
                        //if (!done) {
                            //setTimeout(stopVideos, 6000);		
                        //    done = true;
                        //} else {
                            playVideos(event);
                        //}
						titles[event.target.num] = event.target.getVideoData().title;
						writeTitle();
                        break;
                    case YT.PlayerState.PAUSED:
                        pauseVideos(event);
                        break;
                    case YT.PlayerState.BUFFERING:
                        playVideos(event);
                        break;
                    case YT.PlayerState.CUED:

                        break;
                }
            }

            function toggleVideos() {
				switch (elements.playPause.value) {
					case "Play":
						playVideos();
						elements.playPause.value = "Pause";
						break;
					case "Pause":
					default:
						pauseVideos();
						elements.playPause.value = "Play";
						break;
				}
            }

            function toggleMute(i, force) {
				if(force !== undefined) settings[i].mute = (settings[i].mute == 1 ? 0 : 1);
				switch(settings[i].mute) {
					case 1:
						player[i].unMute();
						settings[i].mute = 0;
						elements.player[i].mute.value = "Mute";
						break;
					case 0:
					default:
						player[i].mute();
						settings[i].mute = 1;
						elements.player[i].mute.value = "Unmute";
						break;
				}
				writePerma();
            }

            function setVolume(i) {
                if (debug) console.log("Side-by-Side Player: Volume Value: " + elements.player[i].volume.value);
                settings[i].volume = elements.player[i].volume.value;
                player[i].setVolume(settings[i].volume);
                writePerma();
            }

            function playVideos(event) {
                var state;
                for (var i = 0; i < player.length; i++) {
                    state = player[i].getPlayerState();
                    if (event && event.target == player[i] || (state == 1 || state == 3)) continue;
                    /*if (stopState)
						player[i].seekTo(time[i].value, !0);
					else
						player[i].playVideo();*/
                    player[i].playVideo();
                    if (stopState) player[i].seekTo(getSec(i), !0);
                    //player[i].seekTo(player[i].getCurrentTime() + time[i].value, !0);
                }
                stopState = 0;
            }

            function pauseVideos(event) {
                var state;
                for (var i = 0; i < player.length; i++) {
                    state = player[i].getPlayerState();
                    if (event && event.target == player[i] || (state != 1)) continue;
                    player[i].pauseVideo();
                }
            }

            //function stopVideos(event, seek) {
            function stopVideos(event) {
                var state;
                for (var i = 0; i < player.length; i++) {
                    state = player[i].getPlayerState();
                    if (event && event.target == player[i] || (state == -1 || state === 0)) continue;
                    //if (seek) player[i].seekTo(time[i].value, !0);
                    //player[i].stopVideo();
                    player[i].seekTo(player[i].getDuration(), !0);
                }
            }

            function setTimes() {
                for (var i = 0; i < player.length; i++) {
                    settings[i].time = getSec(i);
                    player[i].seekTo(settings[i].time, !0);
                    elements.playPause.value = "Pause";
                    writePerma();
                }
            }

            function setVideos() {
                for (var i = 0; i < player.length; i++) {
                    //if (debug) console.log("Side-by-Side Player: Value" + i + " - " + elements.player[i].videoID.value);
                    var parts = parseIDField(elements.player[i].videoID.value);
					if(parts.videoID === undefined) return;
                    //if (debug) console.log("Side-by-Side Player: Parts" + i + " - " + parts);
                    //if (debug) console.log("Side-by-Side Player: Video" + i + " - " + tempVideo);
                    if(parts.time === undefined) parts.time = getSec(i);
                    if (debug) console.log("Side-by-Side Player: parts.time - " + parts.time);
                    //if (debug) console.log("Side-by-Side Player: Time" + i + " - " + parts.time);
                    //settings[i].time = getSec(i);
                    player[i].loadVideoById(parts.videoID, parts.time, "default");
                    elements.player[i].videoID.value = settings[i].videoID = parts.videoID;
                    //time[i].value = settings[i].time = parts.time;
                    sToHMS(parts.time, i);
                    settings[i].time = parts.time;
                    elements.playPause.value = "Pause";
                    writePerma();
                }
            }

            // Implemented based on: http://stackoverflow.com/questions/3452546/javascript-regex-how-to-get-youtube-video-id-from-url
            function parseIDField(string) {
                //var webMatches = /.*(?:youtu\.be\/([a-zA-Z0-9_-]+)(?:\?.*)?|youtube\.com\/(?:embed\/|v\/|watch.*(?:\?|\&)v=)([a-zA-Z0-9_-]+)(?:(?:\?|\&|\#).*)?|^([a-zA-Z0-9_-]+)$)/gm;
                if (debug) console.log("Side-by-Side Player: Matched? " + string.match(/^([a-zA-Z0-9_-]+)$/m));
				var output = {};
                if (string.match(/^([a-zA-Z0-9_-]+)$/m)) {
					output.videoID = string;
					return output;
				}
                if (string.indexOf("%2F")) string = decodeURIComponent(string);
                if (debug) console.log("Side-by-Side Player: Ping.");
                var parameters = paramArray(string);
                if (debug) console.log("Side-by-Side Player: " + parameters);
                if (parameters.v !== undefined) output.videoID = parameters.v;
                else {
                    //var webMatches = /^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?.*v=)([a-zA-Z0-9_-]+).*$/;
                    //var webMatches = /^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/)([a-zA-Z0-9_-]+).*$/;
                    var match = string.match(/^.*(?:youtu.be\/|v\/|u\/\w\/|embed\/)([a-zA-Z0-9_-]+).*$/m);
                    if (match && match[1] !== undefined) output.videoID = match[1];
                }
                if (output.videoID !== undefined) {
                    if (parameters.start !== undefined) output.time = Number(parameters.start);
                    else if (parameters.t !== undefined) output.time = hmsToS(parameters.t);
                    if (debug) console.log("Side-by-Side Player: Time Parameter - " + parameters.t);
                    if (debug) console.log("Side-by-Side Player: Video Parameter - " + output.videoID);
                    return output;
                } else return undefined;
            }

            function paramArray(url, format) {
                var paramList;
                if (url.indexOf("?") > -1) paramList = url.split("?")[1];
                else if (url.indexOf("#") > -1) paramList = url.split("#")[1];
                else return false;
                //var paramList = url.split("?")[1];
                var params = paramList.split(/[#&]/);
                var objects = {};
                for (var i = 0; i < params.length; i++) {
					if(!params[i].length) continue;
                    var paramValue = params[i].split("=");
					if(format.constructor === Array) {
						var found = false;
						for(j = 0; j < format.length; j++) {
							if(paramValue[0].match(format[j])) {
								found = true;
								break;
							}
						}
						if(!found) continue;
					}
                    objects[paramValue[0]] = paramValue[1];
                }
                return objects;
            }

			function isEmpty(obj) {
				return Object.keys(obj).length === 0;
			}

            function processDoubler() {
                //var parameters = elements.doubler.value.split("?")[1].split("&");
                var parameters = paramArray(elements.doubler.value);
                if(parameters.video1) video0.value = parseIDField(parameters.video1).id;
                if(parameters.video2) video1.value = parseIDField(parameters.video2).id;
                if(parameters.start1) sToHMS(parameters.start1, 0);
                if(parameters.start2) sToHMS(parameters.start2, 0);
                writePerma();
            }

            function getSec(i) {
				var obj = {};
                obj.h = Number(elements.player[i].time.hours.value) || 0;
                obj.m = Number(elements.player[i].time.minutes.value) || 0;
                obj.s = Number(elements.player[i].time.seconds.value) || 0;

                return calcSec(obj);
            }

            function hmsToS(timeStamp) {
                if (timeStamp.match(/^\d+$/m)) return timeStamp;
				var obj = {h: 0, m: 0, s: 0};
                var temp;
                temp = timeStamp.match(/(\d+)[hH]/);
                if (temp) obj.h = Number(temp[1]) || 0;
                temp = timeStamp.match(/(\d+)[mM]/);
                if (temp) obj.m = Number(temp[1]) || 0;
                temp = timeStamp.match(/(\d+)[sS]/);
                if (temp) obj.s = Number(temp[1]) || 0;

                return calcSec(obj);
            }

			function calcSec(obj) {
				return (obj.h * 60 * 60) + (obj.m * 60) + obj.s;
			}

            function sToHMS(sec, i) {
                var sec_num = parseInt(sec || 0, 10);
                var h = Math.floor(sec_num / 3600);
                var m = Math.floor((sec_num - (h * 3600)) / 60);
                var s = sec_num - (h * 3600) - (m * 60);

                elements.player[i].time.hours.value = h;
                elements.player[i].time.minutes.value = m;
                elements.player[i].time.seconds.value = s;
            }

            function writePerma(first) {
                var website = window.location.href;
                if (website.indexOf("?") > -1) website = website.split("?")[0];
                var permaParam = [];
                for (var i = 0; i < player.length; i++) {
					if(settings[i] == init[i]) continue;
					if(settings[i].videoID != def.videoID) permaParam.push("video" + i + "=" + settings[i].videoID);
                    if(settings[i].time != def.time) permaParam.push("start" + i + "=" + settings[i].time);
                    if(settings[i].volume != def.volume) permaParam.push("volume" + i + "=" + settings[i].volume);
                    if(settings[i].mute != def.mute) permaParam.push("mute" + i + "=" + settings[i].mute);
                }
                if(permaParam.length) elements.perma.value = website + "?" + permaParam.join("&");
				else elements.perma.value = website;
				if(!first) writeTitle();
            }

			function writeTitle() {
				var sortable = [];
				for (var name in titles)
                     sortable.push([name, titles[name]]);
				sortable.sort(function(a, b) {return a[0] - b[0]});
				var end = [];
				for(var i = 0; i < sortable.length; i++)
					end.push(sortable[i][1]);
				elements.title.innerHTML = end.join(" and ") + " - Side-by-Side Player";
			}

			function updateVideo() {
				var tempParam = paramArray(window.location.hash, [ /video[0-9]+/, /start[0-9]+/, /volume[0-9]+/, /mute[0-9]+/ ]);
				if (!isEmpty(tempParam)) {
					for (var i = 0; i < player.length; i++) {
						if (('video' + i) in tempParam) settings[i].videoID = tempParam['video' + i];
						if (('start' + i) in tempParam) settings[i].time = tempParam['start' + i];
						if (('volume' + i) in tempParam) settings[i].volume = tempParam['volume' + i];
						if (('mute' + i) in tempParam) settings[i].mute = tempParam['mute' + i];
						player[i].loadVideoById(settings[i].videoID, settings[i].time, "default");
						player[i].setVolume(settings[i].volume);
						if(settings[i].mute) toggleMute(i, 1);
						//change = 0;
					}
					writePerma();
				}
			}
        </script>
    </body>

</html>
